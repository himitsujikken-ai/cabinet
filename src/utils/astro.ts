// src/utils/astro.ts

// --- 辞書データ (Source: index-9.html) ---
const DICT = {
    kyusei: ["一白水星", "二黒土星", "三碧木星", "四緑木星", "五黄土星", "六白金星", "七赤金星", "八白土星", "九紫火星"],
    // 戦略テキスト（36パターン完全移植）
    strategies: {
        "一白水星-春": { title: "潜流の覚醒と新たな脈動", body: "雪解け水が川となり、やがて大河へと繋がるように、運命は静かながら力強い流れの中にあります。表面的な派手さはありませんが、水面下での戦略的準備が驚くほどの成果を生むでしょう。" },
        "一白水星-夏": { title: "冷静なる火消しと中和の美学", body: "周囲が熱狂し、感情的に暴走しやすい中で、あなただけが冷静な視点を保つことができます。この温度差こそが、あなたの最大の武器となるでしょう。" },
        "一白水星-秋": { title: "深淵への潜行と知恵の結晶化", body: "深く潜ることを恐れないでください。表面的な成功よりも、本質的な価値の追求が大きなリターンをもたらします。孤独な作業の中に光があります。" },
        "一白水星-冬": { title: "凍結と純化、原点回帰の静寂", body: "無駄なものが削ぎ落とされ、本当に大切なものだけが残る「純化」のプロセスが進みます。外に向かって動くことよりも、内面世界の探求に全力を注ぐべきです。" },

        "二黒土星-春": { title: "大地の目覚めと基盤の構築", body: "種を撒き、水をやり、雑草を抜く。そんな日々のルーチンワークこそが、未来の豊穣を約束します。焦らず、着実に、一歩ずつ進んでください。" },
        "二黒土星-夏": { title: "忍耐の果実と奉仕の精神", body: "華やかな表舞台よりも、縁の下の力持ちとしての役割が光ります。一見損な役回りに思えるかもしれませんが、この時期に積んだ「徳」は、後に大きな信用となって返ってきます。" },
        "二黒土星-秋": { title: "豊穣の収穫と感謝の循環", body: "これまでの誠実な取り組みが形となり、具体的な成果として手元に届きます。受け取った豊かさを独り占めせず、周囲と分かち合うことで、運気はさらに上昇します。" },
        "二黒土星-冬": { title: "大地の休息と次なる構想", body: "休息と充電の時。無理に動こうとせず、心身のメンテナンスを優先してください。来たるべき春に向けて、長期的なビジョンを描くのにも良い時期です。" },

        "三碧木星-春": { title: "雷鳴の始動と革新の狼煙", body: "直感が冴え渡り、アイデアが次々と閃くでしょう。「とりあえずやってみる」という軽快なフットワークが、運命の扉を開きます。失敗を恐れる必要はありません。" },
        "三碧木星-夏": { title: "疾風怒濤と高速展開", body: "情報は鮮度が命。誰よりも早く情報をキャッチし、即座に行動に移すことで、先行者利益を得られます。立ち止まることなく、走りながら考えるスタイルが功を奏します。" },
        "三碧木星-秋": { title: "実りの精算と軌道修正", body: "広げすぎた風呂敷を畳み、本当に必要なものだけを選別する時期です。勢いだけで進めてきた物事に、具体的な数字や形が求められます。" },
        "三碧木星-冬": { title: "雷の沈黙と内なる蓄電", body: "冬の空に雷鳴は響きません。この静寂は、次の春に特大の雷を落とすための充電期間です。口を閉ざし、耳を澄ますことで、重要なヒントが見つかります。" },

        "四緑木星-春": { title: "春風の誘いと良縁の拡大", body: "家に閉じこもっていては勿体無い。積極的に外に出て、人と会い、語り合いましょう。「信用」を積み重ねることで、あなたの周りには強固なネットワークが構築されます。" },
        "四緑木星-夏": { title: "信用という涼風と調整力", body: "人間関係の調整役として重宝されます。あなたのバランス感覚と柔軟性が、組織やチームの調和を保つ要となります。" },
        "四緑木星-秋": { title: "縁の収穫祭と信用の換金", body: "これまで丁寧に紡いできたご縁が、具体的な形となって実を結びます。情報は発信する人のところに集まります。惜しみなくシェアしてください。" },
        "四緑木星-冬": { title: "凪の内省と根回しの時", body: "広がりすぎた人脈を見直し、本当に大切な人との絆を深めることに注力してください。水面下での根回しや、交渉ごとの準備にも最適です。" },

        "五黄土星-春": { title: "帝王の目覚めと破壊的創造", body: "既存のルールや古い慣習を打ち壊し、全く新しい秩序を作り上げるパワーに満ちています。改革には痛みが伴いますが、恐れずにメスを入れてください。" },
        "五黄土星-夏": { title: "灼熱の支配と圧倒的存在感", body: "カリスマ性が最高潮に達します。自信に満ちた決断が大きな成功を引き寄せますが、傲慢さは破滅への入り口です。「支配」ではなく「守護」に力を使ってください。" },
        "五黄土星-秋": { title: "覇道の総括と実力の証明", body: "戦いの季節が終わり、成果を確認する時です。五黄土星の結果は「0か100か」。どのような結果であれ、それを全て受け入れる度量が、器をさらに大きくします。" },
        "五黄土星-冬": { title: "帝王の孤独と深淵なる再生", body: "華やかな舞台から離れ、孤独と向き合う時間が訪れます。誰にも頼らず、自分自身の力で立ち上がる強さを養ってください。闇が深ければ深いほど、次に昇る光は強く輝きます。" },

        "六白金星-春": { title: "天の号令と高潔なる理想", body: "高い理想を掲げて立ち上がる時です。目先の利益にとらわれず、大局的な視点から物事を判断してください。あなたの正義感が、混沌とした状況に秩序をもたらします。" },
        "六白金星-夏": { title: "正義の炎と厳格な規律", body: "不正や怠慢を決して許さない厳しさが、組織の引き締め役として機能します。妥協なき仕事ぶりが評価され、重要なポストを任されるでしょう。" },
        "六白金星-秋": { title: "完璧なる収穫と円熟の境地", body: "研ぎ澄まされた感性と努力が、最高品質の成果となって現れます。「本物」だけが生き残る秋において、あなたの仕事は高い評価を受けるでしょう。" },
        "六白金星-冬": { title: "天の静寂と精神の昇華", body: "現実社会の喧騒から離れ、哲学的・宗教的な思索に耽るのに適した時期です。見返りを求めない行為（陰徳）を積むことで、天の加護が得られます。" },

        "七赤金星-春": { title: "悦楽の開花と社交の華", body: "ユーモア溢れる会話と笑顔で人気者になれるでしょう。「楽しむこと」が最大の開運アクションです。遊びの中からビジネスのヒントが見つかります。" },
        "七赤金星-夏": { title: "黄金の弁舌と交渉の勝利", body: "話術は冴え渡り、言葉を武器にして欲しいものを手に入れることができます。ただし、「多弁は銀、沈黙は金」。約束を守る誠実さを忘れないでください。" },
        "七赤金星-秋": { title: "豊穣の宴と収穫の喜び", body: "人生の喜びを味わい尽くす時です。この幸運は、あなたが周囲を楽しませてきたご褒美です。遠慮せずに受け取り、周囲にも還元してください。" },
        "七赤金星-冬": { title: "宴の終わりと冬支度", body: "祭りの後のクールダウン期間です。出費がかさみやすい時期なので管理をしっかりと。派手さはなくとも、心温まる交流が冷えた心を溶かしてくれます。" },

        "八白土星-春": { title: "山動き始める大転換", body: "人生の大きなターニングポイントです。変化はストレスを伴いますが、今の場所にしがみついていては成長はありません。思い切って一歩を踏み出してください。" },
        "八白土星-夏": { title: "不動の忍耐と頂への道", body: "思うように進まない停滞感があるかもしれませんが、逆境においてこそ強靭な精神力が発揮されます。安易な近道を選ばず、足場を固めてください。" },
        "八白土星-秋": { title: "改革の実現と新秩序", body: "あなたが主導してきた改革が、ようやく周囲に理解され評価されます。伝統を守りつつ革新を取り入れる、その絶妙なバランス感覚が光ります。" },
        "八白土星-冬": { title: "静寂の山岳と孤高の戦略", body: "次の改革に向けた長期的な戦略を練るのに最適な時期です。孤独な環境でこそ、深い思考と洞察力が生まれます。" },

        "九紫火星-春": { title: "太陽の昇天と知性の輝き", body: "隠されていた才能が日の目を見たり、スポットライトを浴びる機会が増えます。直感力と先見性が冴え渡り、誰も思いつかないアイデアで世界を驚かせます。" },
        "九紫火星-夏": { title: "炎の絶頂と情熱の奔流", body: "情熱のままに行動することで道が拓けます。燃え尽きることを恐れず、完全燃焼してください。その情熱の炎で、周囲の人々の心にも火をつけてください。" },
        "九紫火星-秋": { title: "夕陽の美学と去り際の哲学", body: "物事の「終わり」や「離別」を経験するかもしれませんが、それは次のステージへの卒業です。執着を手放すことで、洗練された美意識を手に入れます。" },
        "九紫火星-冬": { title: "灯火の導きと希望の光", body: "冬の闇夜を照らす蝋燭の火のように、あなたの存在が人々の希望となります。悩み苦しむ人に寄り添い、知恵と慈愛で道を指し示すガイド役としての使命があります。" }
    }
};

export const AstroLogic = {
    // 九星算出
    getKyusei: (y: number) => {
        let s = 0; String(y).split('').forEach(n => s += parseInt(n));
        while (s > 9) s = String(s).split('').reduce((a, b) => parseInt(a) + parseInt(b), 0);
        let t = 11 - s; if (t > 9) t -= 9; if (t === 0) t = 9;
        return { index: t, name: DICT.kyusei[t - 1] };
    },

    // 季節の判定 (3-5:春, 6-8:夏, 9-11:秋, 12-2:冬)
    getSeason: (m: number) => {
        if (m >= 3 && m <= 5) return "春";
        if (m >= 6 && m <= 8) return "夏";
        if (m >= 9 && m <= 11) return "秋";
        return "冬";
    },

    // CNLスコア（エネルギーバランス）簡易版
    analyzeBalance: (y: number, m: number) => {
        const kNum = AstroLogic.getKyusei(y).index;
        let active = 10; let passive = 10;

        // 九星加点
        if ([3, 4, 9].includes(kNum)) active += 30; // 木・火
        if ([1, 6, 7].includes(kNum)) passive += 30; // 水・金
        if ([2, 5, 8].includes(kNum)) { active += 15; passive += 15; } // 土

        // 季節加点
        if (m >= 3 && m <= 8) active += 20;
        else passive += 20;

        // 判定
        let type = "バランス型 (Balance)";
        let advice = "中庸を保ち、状況に応じて動くこと";
        if (active > passive * 1.5) {
            type = "推進力重視 (Attack)";
            advice = "今は攻めの時。リスクを恐れず前進せよ。";
        } else if (passive > active * 1.5) {
            type = "内部蓄積重視 (Defense)";
            advice = "今は守りの時。地盤を固め、時を待て。";
        }

        return { active, passive, type, advice };
    },

    // メイン分析関数
    analyze: (dateStr: string) => {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return null;

        const y = date.getFullYear();
        const m = date.getMonth() + 1;
        const d = date.getDate();

        const kyusei = AstroLogic.getKyusei(y);
        const season = AstroLogic.getSeason(m);
        const key = `${kyusei.name}-${season}`; // 例: "一白水星-冬"
        // @ts-ignore
        const strategy = DICT.strategies[key] || { title: "解析不能", body: "データ不整合" };
        const balance = AstroLogic.analyzeBalance(y, m);

        // 賢人に渡す「機密調査書」
        return `
【ユーザー運命分析データ (Cosmic Neural Logic)】
- 生年月日: ${y}年${m}月${d}日
- 本質: ${kyusei.name}
- 現在の季節運: ${season}
- エネルギー状態: ${balance.type} (能動:${balance.active} / 受動:${balance.passive})
- ★現在の戦略指針(Strategy):
  「${strategy.title}」
  ${strategy.body}

【AIへの指示】
この分析結果に基づき、以下の振る舞いをすること。
1. ナビゲーターは、冒頭で「${strategy.title}」というキーワードを用いて現状を解説せよ。
2. 「推進力重視」なら信長や龍馬を、「内部蓄積」なら空海や家康・渋沢を優先的に選抜せよ。
3. ユーザーへのアドバイスは、上記戦略指針に沿ったものにすること。
        `;
    }
};